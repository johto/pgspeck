language: c

compiler:
  - clang
  - gcc

before_install:
  - psql --version
  - sudo /etc/init.d/postgresql stop
  - sudo apt-get -y --purge remove postgresql libpq-dev libpq5 postgresql-client-common postgresql-common
  - sudo rm -rf /var/lib/postgresql
  - wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
  - sudo sh -c "echo deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main $PGVERSION >> /etc/apt/sources.list.d/postgresql.list"
  - sudo apt-get update -qq
  - sudo apt-get -y -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confnew install postgresql-$PGVERSION postgresql-server-dev-$PGVERSION postgresql-contrib-$PGVERSION
  - sudo chmod 777 /etc/postgresql/$PGVERSION/main/pg_hba.conf
  - echo "local     all         all                               trust" > /etc/postgresql/$PGVERSION/main/pg_hba.conf
  - sudo /etc/init.d/postgresql restart

env:
  global:
    - PGDATABASE=postgres
    - PGUSER=postgres

  matrix:
    - PGVERSION=11
    - PGVERSION=10
    - PGVERSION=9.6
    - PGVERSION=9.5
    - PGVERSION=9.4
    - PGVERSION=9.3
    - PGVERSION=9.2
    - PGVERSION=9.1

addons:
  sonarcloud:
    organization: "johto"
    token:
      secure: "M/DMMy8iZt1nVWYncRuvS3aBwirH3JpcLetKCrOiiZpbKALNjf1cosx4gUbxJI7ZbDqm3I2OtR+3S51EKh2h3b2oR7o+nUnEnTRRqT0+/nm5ogkV8SYUXooaz9AgqLliol0XDBM+MT3v75dSsnCaJDX3FwfY/TFl+NpKEFGtm4uPR8eD9xsU+quMUF5IipgQEKDzviEfw1pwPGN98qMpXIeX4kQ+SHND5PsTGbLKtIQ1AIbUGhKfNEwM0A69Gi6qZCBT4DMCaj0iVwwcu1nTt9gs8r7FafIy0qS2f6/+HSx3tFEpZrCco4jM2ulz8bAhsNSrcj2IHuBsjURPud8re+594mz9mWDzoiekOONNK+67biG58u+EkIu38aJ1B51bpoxOZBt0DqPooPQ6gHDf5k/Mon6T8O7ddxTrleoNrgxmECXvKyBm0IKj+upGIhnOfoGeAZJX61TqLUwGd16fl1HoB35JvPlOG6F48wx203U+n/tKo9j9YbxdFLzdoQLJybmfT51SsTk1DBXdL4l7Yx6HVjy3OmbPnhPLjxtHaxApZBIp2bwfDxf/rOJ9AcaXsT76P0oN/t0mz3Lyo8H7zGQyM0uqNAb/xBT94JjHr4ljbdhni6/jebpRzz/JahKZqY2SI2dEV4/2qlLOIlrUcEAN7N/lirVcaUkggp+AKuw="

script:
 - build-wrapper-linux-x86-64 --out-dir bw-output make
 - sudo make install
 - make installcheck || (cat regression.diffs && /bin/false)
 - sonar-scanner
